\chapter{Anomalies}
\label{chap:Anomalies}
To ensure that the prediction and classification of anomalies are not based on generalised sensor failures a few anomalies are simulated. These anomalies are either chosen to show the significant effect of these anomalies on the ADCS or are modelled based on research that label the anomaly as a possible influence on the ADCS. There is a anomaly for each sensor, that will create inaccuracies for that specific sensor measurement. An anomaly for the reaction wheels is also implemented to show the resulting estimation failure based on a inaccurate model update, since the control torque and the torque implemented is not the same. This anomaly will also be predicted based on the sensor readings, since the effect will be evident on all the sensors.

\section{Reflection of Solar Panels on Sun Sensor}
\label{section:Reflection}
Sun reflection from solar panels unto sun sensors is a very probable anomaly, if the sun sensor is not placed in a position where the reflection will not influence the sensor. Reflection on the sun sensor is modelled to determine whether the reflection has a significant effect on the ADCS. The reflection anomaly is modelled for the specific shape and design of the CubeSat as shown in Figure~\ref{fig:CubeSat}. The CubeSat will also be the same design for all of the modelled anomalies.

The reflection anomaly is modelled for the specific shape and design of the satellite as shown in Figure~\ref{fig:CubeSat}.  The modelling takes place within the SBC frame.

\begin{figure}[h!t!b]
	\centering
	\def\svgwidth{12cm}
	\import{Figures/}{ReflectionModel.pdf_tex}
	\caption{The modelled satellite, with solar panels and sun sensor within the SBC frame.}
	\label{fig:CubeSat}
\end{figure}

\begin{figure*}[h!t!b]
	\centering
	\def\svgwidth{7cm}
	\import{Figures/}{ReflectionModelPoint.pdf_tex}
	\centering
	\def\svgwidth{7cm}
	\import{Figures/}{LineIntersection.pdf_tex}
	\caption{Definition of solar reflection point from $ABCD$-plane.}
	\label{fig:LineIntersection}
\end{figure*}

The assumption is that the solar panel can be modeled as a geometric plane. Therefore, light from the solar panel will reflect similarly to a perfectly smooth mirror. This model also assumes, that if the sun sensor detects any reflection from the solar panel, the measured sun vector will default to the reflection ray instead of the direct sun vector. In practice, this is a function of the exact detection algorithm within the sensor, and some reflections might be ignored.  This assumption will produce the worst-case behaviour.  The intensity of the light vector is also disregarded.

The solar panel $ABCD$-plane can be represented in the SBC by a point and normal vector defined as
\begin{equation}
\begin{split}
\mathbf{p}_{ABCD} &= [p_x,~p_y,~p_z]^\top, \text{and}\\
\bar{\mathbf{n}}_{ABCD} &= [n_px,~n_py,~np_z]^\top,
\end{split}
\end{equation}
respectively.  Similarly, the sun sensor $WXYZ$-plane is represented by the point, $\mathbf{p}_{WXYZ}$, and normal vector, $\bar{\mathbf{n}}_{WXYZ}$.

The reflected sun vector, $\mathbf{r}_{\text{ref}}$, can be calculated by
\begin{equation}
\mathbf{r}_{\text{ref}} = \mathbf{r}_{\text{sun}} - 2\bar{\mathbf{n}}_{ABCD}^\top(\mathbf{r}_{\text{sun}} \cdot \bar{\mathbf{n}}_{ABCD}),
\end{equation}
where $\mathbf{r}_{\text{sun}}$ is the incoming sun vector.  To calculate the intersection of the reflected vector with the $WXYZ$-plane of the sun sensor, the equation of the $WXYZ$-plane, the reflected vector, and the point of origin is required. The reflection of the sun vector is illustrated in Figure~\ref{fig:LineIntersection}. The reflection from $Q$ to $Q'$ can thus be calculated as a projection of $\mathbf{r}_{\text{ref}}$ unto the $WXYZ$-plane.

To model reflection from the solar panels to the sun sensor, only two corners of the solar panel and two corners of the sun sensor are to be considered. From Figure~\ref{fig:LineIntersection} it is evident that if the solar panel reflects on $Y$ that the reflection will also cover $X$. The same is true for corner $Z$ and $W$. Since $C'$ will be at the same position as $C$, which is valid for $D'$ and $D$, the calculation can be omitted. Therefore it is only necessary to calculate the reflected positions $A'$ and $B'$. This simplifies the reflection model significantly.

The reflected position $A'$ can be calculated as the intersection of the reflected vector $R$ with plane $WXYZ$. We also know the position of $A$, based on the satellite design, and can therefore calculate $A'$. The same applies to $B$ and $B'$. To determine whether $Y$ or $X$ is within the reflection region, we assume that the plane $WXYZ$ is a 2D plane, and we omit the third dimension. Therefore, the axis changes from $x, y, z$ to only $x, y$. We calculate whether $x$ is between the lines of $A'D$ and $B'C$ and between the lines $CD$ and $A'B'$. By determining the line equation between reflected points in the form 
\begin{equation}
y_{A'B'} = mx_{A'B'} + c,
\label{eq:line equation}
\end{equation}
from the coordinates of $A'$ and $B'$, the corresponding $X_{A'B',y}$ can be calculated by substituting $X_x$ into Eq~\ref{eq:line equation}. With the same method the coordinates of $X_{B'C}$, $X_{A'D}$, $X_{A'B'}$ and $X_{CD}$ can be determined. After that, with logical if statements, it can be determined whether $X$ is in the reflection zone. If $X_x$ is to the right of $X_{B'C,x}$ and to the left of $X_{A'D,x}$, as well as $X_y$ is above $X_{A'B',y}$ and below $X_{CD,y}$ then $X$ is within the reflection zone. 

The results for the sun vector with and without reflection are shown in Figure~\ref{fig:Sun Vector comparison}. There is a clear difference between the true sun vector and the possible measurement influenced by the reflection.  This false reflection vector may affect the estimation and, thus also the attitude control of the satellite.

\begin{figure*}[!htb]
	\begin{tabular}{@{}c@{}}
		\centering
%		 include first image
		\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/Reflection/}{Sun.pgf}
%		\caption[Sun vector with reflection]{Sun vector with reflection.}
		\label{fig:Sun Vector comparison with reflection}
	\end{tabular}
	\begin{tabular}{@{}c@{}}
		\centering
		% include second image
		\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/None/}{Sun.pgf} 
%		\caption[Sun vector without reflection]{Sun vector without reflection.}
		\label{fig:Sun Vector comparison without reflection}
	\end{tabular}
	
	\caption{Comparison of Sun Vector with and without Reflection}
	\label{fig:Sun Vector comparison}
	
\end{figure*}

%\begin{figure}[!htb]
%	\centering
%	\def\svgwidth{14cm}
%	\import{Figures/}{ReflectionModel.pdf_tex}
%	\caption{Cube Sat}
%	\label{fig:CubeSat}
%\end{figure}
%
%\begin{figure*}[!hbt]
%	\centering
%	\def\svgwidth{7cm}
%	\import{Figures/}{ReflectionModelPoint.pdf_tex}
%	\centering
%	\def\svgwidth{7cm}
%	\import{Figures/}{LineIntersection.pdf_tex}
%	\caption{Reflection}
%	\label{fig:LineIntersection}
%\end{figure*}
%
%The assumption is that the solar panel can be modelled as a geometric plane. Therefore, light from the solar panel will reflect as from a perfectly smooth mirror. It is further assumed that if the sun sensor detects any reflection from the solar panel, the measured sun vector will default to the reflection ray instead of the direct sun vector. Therefore the intensity of the light vector is disregarded. The reflected sun vector, $r$, can be calculated as
%\begin{equation}
%	\mathbf{r} = \mathbf{v} - 2\mathbf{n}^T(\mathbf{v} \cdot \mathbf{n}).
%\end{equation}
%Where $\mathbf{v}$ is the incoming sun vector and $\mathbf{n}$ is the average vector to the plane $ABCD$ of the solar panel, as seen in Figure~\ref{fig:CubeSat}. To calculate the intersection of the reflected vector with the plane $XWYZ$ of the sun sensor, the equation of the plane, $XWYZ$, the reflected vector, $r$, and the point of origin is required. The reflection of the sun vector, $\mathbf{v}$ is illustrated in Figure~\ref{fig:LineIntersection} The equation for a plane can be denoted as
%
%\begin{equation}
%	\mathbf{p} = ax + by + cz + d.
%	\label{eq:Plane}
%\end{equation}
%Where $x$, $y$ and $z$ are the dimensions in the SBC frame. The reflected unit vector can also be translated to 
%\begin{equation}
%	\begin{aligned}
%		&	x = \alpha t \\
%		&	y = \beta t \\
%		&	z = \zeta t \\
%	\end{aligned}
%	\label{eq:LineOfVector}
%\end{equation}
%Where the coefficients, $\alpha$, $\beta$ and $\zeta$ are the values of the reflected unit vector in each respective dimension. Since we can calculate the coefficients for Eq~\ref{eq:LineOfVector} from the reflected vector, we can calculate $t$, by substituting $x$, $y$ and $z$ into Eq~\ref{eq:Plane}. This is possible, because we determine the equation of the plane for the surface $XYZW$ based on our design. 
%
%After that, the intersecting point with the plane $XYZW$ can be calculated as
%\begin{equation}
%	P(x, y, z) = (o_1 + \alpha t, o_2 + \beta t, o_3 + \zeta t)
%	\label{eq:Intersection}
%\end{equation}
%where $o_1, o_2, o_3$ is the point of origin. Which in this case is the position of reflection from the solar panel. Therefore, if the sun vector $\mathbf{v}$ reflected from the solar panel as $\mathbf{r}$, the point of intersection $Q'$ on Figure~\ref{fig:LineIntersection} can be calculated as
%\begin{equation}
%	Q'(x, y, z) = (Q_x + \alpha t, Q_y + \beta t, Q_z + \zeta t)
%	\label{eq:SpecificIntersection}
%\end{equation}
%
%To model reflection from the solar panels to the sun sensor, only two corners of the solar panel and two corners of the sun sensor are to be considered. From Figure~\ref{fig:LineIntersection} it is evident that if the solar panel reflects on $Y$ that the reflection will also cover $X$. The same is true for corner $Z$ and $W$. Since $C'$ will be at the same position as $C$, which is valid for $D'$ and $D$, the calculation can be omitted. Therefore it is only necessary to calculate the reflected positions $A'$ and $B'$. This simplifies the reflection model significantly.
%
%The reflected position $A'$ can be calculated as the intersection of the reflected vector $R$ with plane $XYZW$ using Eq~\ref{eq:Intersection}. We also know the position of $A$, based on the satellite design and can therefore calculate $A'$. The same applies to $B$ and $B'$. To determine whether $Y$ or $X$ is within the reflection region, we assume that the plane $XYWZ$ is a 2D plane, and we omit the third dimension. Therefore, the axis changes from $x, y, z$ to only $x, y$. We calculate whether $x$ is between the lines of $A'D$ and $B'C$ and between the lines $CD$ and $A'B'$. By determining the line equation between reflected points in the form 
%\begin{equation}
%	y_{A'B'} = mx_{A'B'} + c
%	\label{eq:line equation}
%\end{equation}
%from the coordinates of $A'$ and $B'$, the corresponding $X_{A'B',y}$ can be calculated by substituting $X_x$ into Eq~\ref{eq:line equation}. With the same method the coordinates of $X_{B'C}$, $X_{A'D}$, $X_{A'B'}$ and $X_{CD}$ can be determined. After that, with logical if statements, it can be determined whether $X$ is in the reflection zone. If $X_x$ is to the right of $X_{B'C,x}$ and to the left of $X_{A'D,x}$, as well as $X_y$ is above $X_{A'B',y}$ and below $X_{CD,y}$ then $X$ is within the reflection zone. 
%
%The results for the sun vector with and without reflection is shown in Figure~\ref{fig:Sun Vector comparison}. During the modelling of the reflection, the reflection also affects the estimation and, therefore, the attitude control of the satellite. In the figures of this article, the grey zones indicate the eclipse period, as seen in Figure~\ref{fig:Sun Vector comparison}.
%
%\begin{figure*}[!htb]
%	\begin{tabular}{@{}c@{}}
%		\centering
%%		 include first image
%		\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/Reflection/}{Sun.pgf}
%%		\caption[Sun vector with reflection]{Sun vector with reflection.}
%		\label{fig:Sun Vector comparison with reflection}
%	\end{tabular}
%	\begin{tabular}{@{}c@{}}
%		\centering
%		% include second image
%		\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/None/}{Sun.pgf} 
%%		\caption[Sun vector without reflection]{Sun vector without reflection.}
%		\label{fig:Sun Vector comparison without reflection}
%	\end{tabular}
%	
%	\caption{Comparison of Sun Vector with and without Reflection}
%	\label{fig:Sun Vector comparison}
%	
%\end{figure*}

\subsection{Influence of anomaly on estimation}
To determine whether the reflection on the sun sensor has a influence on the ADCS, the estimation metric is shown in Figure~\ref{fig:reflectionEstimation}. The estimation metric, is the angle difference between the actual attitude and the estimated attitude. It is evident that the reflection has a large influence on the estimation. It is also clear that during the eclipse the estimation returns to a more accurate estimation. This is due to the fact that all sensors are ignored if the measured vector is $0$.
\begin{figure}[!htb]
	\centering
	
	\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/Reflection/}{Estimation Metric.pgf}
	
	\caption{Estimation Metric with reflection on sun sensor}
	\label{fig:reflectionEstimation}
\end{figure}

\section{Moon and Sun in Field of View of Nadir Sensor}
An anomaly that can be experienced by an infra-red (IR) nadir sensor is the moon overlapping the horizon of the Earth in die nadir sensor's field of view (FoV). This is shown in Figure~\ref{fig:ProjectionOnPlane}. This influences the edge detection and circular fit algorithm \cite{Wessels2018, Helgard2008} and consequently the calculated centre of the Earth. Firstly, it is required to simulate the image seen by the nadir sensor, thereafter the algorithm for detecting the centre of the Earth can be implemented.

\subsection{Simulating Nadir Sensor Infra-red Image}
Firstly the vectors of both the satellite to Earth and the moon the Earth is required. The moon position is determined with the Julian date, since the propagation of the moon position relative to the centre of the Earth has already been done. These vectors are shown in Figure~\ref{fig:EarthMoonSatPosition}. From the vector, $\mathbf{R}_{SE}$, and the position of the centre of the Earth, $P_{Earth}$, a 3D plane normal to $\mathbf{R}_{SE}$ and at $P_{Earth}$ can be calculated. Where both $P_{Earth}$ and $\mathbf{R}_{SE}$ are defined as

\begin{figure}[!htb]
	\centering
	\def\svgwidth{14cm}
	\import{Figures/}{EarthMoonSatPosition.pdf_tex}
	\caption{Earth to Moon and Earth to Satellite Vectors}
	\label{fig:EarthMoonSatPosition}
\end{figure}

\begin{equation}
	P_{Earth} = [x_0, y_0, z_0]
\end{equation}

and  

\begin{equation}
	\mathbf{R}_{SE} = [n_x, n_y, n_z].
\end{equation}

Therefore with the equation for the 3D plane defined as 

\begin{equation}
Ax + By + Cy = D
\end{equation}

the parameters $A, B, C, D$ can be calculated as

\begin{equation}
\begin{bmatrix}
	A\\
	B\\
	C\\
	D\\
\end{bmatrix} = \begin{bmatrix}
n_x\\
n_y\\
n_z\\
n_xx_0 + n_yy_0 + n_zz_0\\
\end{bmatrix}
\end{equation}

This 3D plane slicing the Earth in half as seen from the satellite is shown in Figure~\ref{fig:PlaneThroughEarth}. The moon and Earth can both be projected unto the 3D plane to determine the image seen by the nadir sensor. Therefore the nadir vector must also be projected unto the 3D plane. A circle can be drawn for the Earth. moon and the nadir sensor FoV. The radius, of the moon as projected on the 3D plane can be calculated as 

\begin{equation}
	R_{moon} = \norm{R_{SE}} \frac{r_{moon}}{\norm{R_{SM}}}
\end{equation}

the radius of the nadir sensor FoV, $R_{FoV}$ can calculated as 

\begin{equation}
	R_{FoV} = \norm{R_{SE}} \tan \theta
\end{equation}

With these variables defined and calculated, the edges of the moon and Earth within the nadir FoV can be determined.

% Update the image that Rse should be the vector from the nadir sensor (SBC to ORC)
% because the vector is normal to the plane, the depth coordinate can be ignored

\begin{figure}[!hbt]
	\centering
	\def\svgwidth{14cm}
	\import{Figures/}{PlaneThroughEarth.pdf_tex}
	\caption{Plane perpendicular to $\mathbf{R}_{SE}$ and at center of Earth}
	\label{fig:PlaneThroughEarth}
\end{figure}

Firstly the edges of the moon and Earth are discretely determined based on a fixed number of points for the Earth, $N$, and the number of discrete points on the moon is determined based on the ratio of $R_{moon}$ to $R_{Earth}$. The projected Earth and moon unto the 3D plane is shown in Figure~\ref{fig:PlaneThroughEarth}. The discrete edges of the Earth that is within the FoV and will be used for the algorithm discussed in section~\ref{section: Calculating the Centre of the Earth} are determined with the following logical statements.
\begin{enumerate}
	\item Distance between point and centre of nadir Sensor FoV must be smaller than $R_{FoV}$.
	\item Distance between point and centre of moon must be larger than $R_{moon}$
\end{enumerate}

The discrete edges of the moon used for the algorithm is must satisfy the following conditions
\begin{enumerate}
	\item Distance between any discrete point and centre of Earth must be smaller than $R_{Earth}$ for the moon to overlap the horizon
	\item Distance between point and centre of nadir Sensor FoV must be smaller than $R_{FoV}$.
	\item Distance between point and centre of Earth must be larger than $R_{Earth}$
\end{enumerate}

This the creates the array of points that will be used in the algorithm used to calculate the centre of the Earth.

\begin{figure}[!hbt]
	\centering
	\def\svgwidth{14cm}
	\import{Figures/}{ProjectionOnPlane.pdf_tex}
	\caption{Projection of moon and Earth on plane}
	\label{fig:ProjectionOnPlane}
\end{figure}

\subsection{Calculating the Centre of the Earth}
\label{section: Calculating the Centre of the Earth}
The edges of the Earth are detected based on a gradient between the lowest temperature and the highest temperature within the IR nadir sensor's FoV. This will not be implemented in our case, since we can determine discrete points of both the Earth and the moon from the simulation environment. Furthermore the visible phases of the moon will not be accounted for. The reasoning for this is due to the coldest side of the moon being $140K$ and the warmest part, $400K$. The temperature of space is $2.7K$ and the coldest part on the Earth is $180K$. Consequently, the IR horizon sensor must be calibrated to always use the minimum value for edge detection as 180K or it must use the smallest value in the image, which will most likely be $2.7K$. Therefore, it can be assumed that the moon will not have any detectable phases for the IR horizon sensor and it will always be seen as a full moon, due to it's lowest temperature being warmer than that of space. 

With this assumption the circular fit algorithm as shown in Figure~\ref{fig:CircularFit} can now be used to determine the centre of the Earth on the plane \cite{Wessels2018}. For this calculation the 3D plane is transformed to a 2D plane and all the coordinates is also transformed.  

\begin{figure}[!hbt]
	\centering
	\def\svgwidth{14cm}
	\import{Figures/}{CircularFit.pdf_tex}
	\caption{Circular Fit Algorithm}
	\label{fig:CircularFit}
\end{figure}

Firstly the curvature is described as 

\begin{equation}
	ax + bx + c = x^2 + y^2
\end{equation}

where 

\begin{equation}
	\begin{aligned}
		a &= 2x_c \\
		b &= 2y_c \\
		c &= r_c^2-\sqrt{x_c^2 + y_c^2}
	\end{aligned}
\end{equation}

Therefore using all the discrete edges within the image $a$, $b$ and $c$ can be calculated as

\begin{equation}
	\begin{bmatrix}
		x_0 & y_0 & 1\\
		x_1 & y_1 & 1\\
		\vdots & \vdots & \vdots\\
		x_n & y_n & 1\\
	\end{bmatrix}	\begin{bmatrix}
	a\\
	b\\
	c
\end{bmatrix} = \begin{bmatrix}
		x_0^2 + y_0^2\\
		x_1^2 + y_1^2\\
		\vdots \\
		x_n^2 + y_n^2\\
	\end{bmatrix}
\end{equation}

where $(x_0,y_0)$ to $(x_n, y_n)$ are the coordinates of the discrete edges. It is thus evident that when the moon overlaps the horizon of the Earth from the nadir sensor's perspective the centre of the Earth will be incorrectly calculated and this anomaly must be dealt with. The other anomaly in this section where the sun is in the FoV of the nadir sensor will not provide a measurement, since the sun will saturate the Infra-red nadir sensor~\cite{Wessels2018}.

\subsection{Influence of anomaly on estimation}
To determine the effect of the moon in the circular fit algorithm the measured Earth vector with and without the moon on horizon anomaly is shown in Figure~\ref{fig:Earth Vector comparison}. It is clear from Figure~\ref{fig:Earth Vector comparison} that the anomaly has no visible effect on the Earth vector. It is also evident in Figure~\ref{fig:Moon On Horizon Estimation Metric} that the estimation metric is also not influenced negatively by this anomaly. Therefore, this anomaly is not included in the FDIR development, since there is no evident difference due to the anomaly.
\begin{figure*}[!htb]
	\begin{tabular}{@{}c@{}}
	\centering

	\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/MoonOnHorizon/}{Earth.pgf}
	
	\label{fig:Earth Vector comparison with moon on the horizon}
	\end{tabular}
	\begin{tabular}{@{}c@{}}
		\centering
		% include second image
		\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/None/}{Earth.pgf} 
		%		\caption[Sun vector without reflection]{Sun vector without reflection.}
		\label{fig:Sun Vector comparison without moon on the horizon}
	\end{tabular}
	
	\caption{Comparison of Earth Vector with and without moon on the horizon}
	\label{fig:Earth Vector comparison}
	
\end{figure*}

\begin{figure}[!htb]
	\centering
	
	\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/MoonOnHorizon/}{Estimation Metric.pgf}
	
	\caption{Earth Values}
	\label{fig:Moon On Horizon Estimation Metric}
\end{figure}


\section{Magnetic Moment Disturbance from Satellite Bus}
Magnetic moments produced by a coil in solar panels on a CubeSat can create a disturbance torque an influence the magnetometer measurements due to the induced magnetic field in the coil of the solar panel~\cite{Ruckerl2019, Jeger2017}. According to \cite{Jeger2017} the current, $I$, in each individual cell of the solar panel can be modelled as a cumulative current for the entire solar panel, since the normal vector to each cell and the solar panel is the same. This magnetic moment is modelled for the specific size of the CubeSat model in Figure~\ref{fig:CubeSat}. The coil in the solar panel and the resulting magnetic field, $B(r)$, as well as the resulting dipole moment, $m$, is shown in Figure~\ref{fig:solarPanelDipole}. The inner area of the coil is assumed to be the same as the surface area of the solar panel. 

\begin{figure}[!hbt]
	\centering
	\def\svgwidth{14cm}
	\import{Figures/}{solarPanelDipole.pdf_tex}
	\caption{Dipole Moment from circular loop in solar panel}
	\label{fig:solarPanelDipole}
\end{figure}

The dipole moment is calculated as
\begin{equation}
m = AI
\end{equation}
where $A$ is the area within the loop and $I$ is the current within the coil. The current is generated by the solar panel and thus depends on the incoming sun vector as well as the area on the solar panel illuminated by the sun as demonstrated in Figure~\ref{fig:Shadow}. 
\begin{figure}[!hbt]
	\centering
	\def\svgwidth{14cm}
	\import{Figures/}{Shadow.pdf_tex}
	\caption{Shadow created by CubeSat body on Solar Panels}
	\label{fig:Shadow}
\end{figure}
Therefore the current, $I$, can be calculated with
\begin{equation}
I = I_{max}\frac{A_{total}}{A_{illuminated}}cos(\theta)
\end{equation}
where $\theta$ is the angle between the normal vector to the solar panel and the incoming sun vector and $I_{max}$ depends on the solar panel. The dipole moment in term produces a disturbance torque on the CubeSat. With the resulting torque expressed as
\begin{equation}
\tau = m \times B
\end{equation}
where $B$ is the magnetic field of the Earth. Since the only external magnetic field that create a resulting torque is that of the Earth. The resulting torque for five orbits are shown in Figure~\ref{fig:solarPanel Disturbance Torques}.
\begin{figure}[!htb]
	\centering
	
	\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/solarPanelDipole/}{SolarPanelDipole Torques.pgf}
	
	\caption{Solar Panel Disturbance Torques}
	\label{fig:solarPanel Disturbance Torques}
\end{figure}

The magnetometer measurement influenced by the magnetic field produced by the coil in the solar panel. This magnetic field experienced at the magnetometer can be calculated with 
\begin{equation}
B(r) = \frac{\mu_0}{4\pi} \frac{3 \hat{r} (\hat{r} \cdot m) - m}{\norm{r}^3}
\end{equation}

\subsection{Influence of anomaly on estimation}
The vector $r$ between the position of the magnetometer and the solar panel influences the magnetic field significantly. The experienced magnetic field  by the magnetometer will be different for each solar panel. The resulting measured vector by the magnetometer is the summation of the Earth's magnetic field and the magnetic field produced by the coils in the solar panels. The resulting magnetometer measurement with and without the induce moment is shown in Figure~\ref{fig:Magnetometer Vector comparison}. From Figure~\ref{fig:solarPanelDipoleOnEstimation} is is evident that this anomaly has a significant effect on the estimation, but not as large as the reflection on the sun sensor. 

\begin{figure*}[!htb]
	\begin{tabular}{@{}c@{}}
		\centering
		
		\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/solarPanelDipole/}{Magnetometer.pgf}
		
		\label{fig:Magnetic field Vector comparison with solar Panel magnetic field}
	\end{tabular}
	\begin{tabular}{@{}c@{}}
		\centering
		% include second image
		\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/None/}{Magnetometer.pgf} 
		%		\caption[Sun vector without reflection]{Sun vector without reflection.}
		\label{fig:Magnetic field Vector comparison without solar Panel magnetic field}
	\end{tabular}
	
	\caption{Comparison of Magnetic field Vector with and without solar Panel magnetic field}
	\label{fig:Magnetometer Vector comparison}
\end{figure*}

\begin{figure}[!htb]
	\centering
	
	\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/solarPanelDipole/}{Estimation Metric.pgf}
	
	\caption{Estimation Metric with induced dipole moment}
	\label{fig:solarPanelDipoleOnEstimation}
\end{figure}

\section{Reaction wheels}
When an actuator fails it influences all the sensor measurements. The anomaly will be modelled as a sudden failure in the actuator when it does not react to inputs. This will influence the EKF, since the model update will be inaccurate. Therefore, this anomaly is included even though it is not a sensor anomaly, because it often occurs and a lot of research is done in this. The recovery of this will however will not be within the specification of this thesis, but the model update for the estimation will be modified based on a modified torque vector. The resulting estimation metric for this anomaly is shown in Figure~\ref{fig:catastrophicReactionWheels} and it is evident that this anomaly has a large negative effect on the EKF. \textbf{maybe use the angular moment sensors to update the torque}.

\begin{figure}[!htb]
\centering

\import{Figures/TexFigures/Predictor-None/Isolator-None/Recovery-None/EARTH_SUN-ORC-General CubeSat Model/catastrophicReactionWheel/}{Estimation Metric.pgf}

\caption{Estimation Metric with failure of Reaction Wheels}
\label{fig:catastrophicReactionWheels}
\end{figure}

\section{Summary}
Based on the influence of the modelled anomalies on the estimation metric. Therefore the reflection of the solar panels on the sun sensor, the induced magnetic dipole and the failed reaction wheel are used for the FDIR development.

%\begin{figure}[!htb]
%	\centering
%	
%	\import{Figures/TexFigures/Summary/EKF-ignore/}{Estimation MetricSVM.pgf}
%	
%	\caption{Estimation Metric with failure of Reaction Wheels}
%	\label{fig:catastrophicReactionWheels}
%\end{figure}
%
%\begin{figure}[!htb]
%	\centering
%	
%	\import{Figures/TexFigures/Summary/EKF-ignore/}{Pointing MetricSVM.pgf}
%	
%	\caption{Estimation Metric with failure of Reaction Wheels}
%	\label{fig:catastrophicReactionWheels}
%\end{figure}
%
%\begin{figure}[!htb]
%	\centering
%	
%	\import{Figures/TexFigures/Summary/EKF-ignore/}{Prediction AccuracySVM.pgf}
%	
%	\caption{Estimation Metric with failure of Reaction Wheels}
%	\label{fig:catastrophicReactionWheels}
%\end{figure}
%
%
%\begin{figure}[!htb]
%	\centering
%	
%	\import{Figures/TexFigures/Summary/None/}{Estimation MetricNoFailure.pgf}
%	
%	\caption{Estimation Metric with failure of Reaction Wheels}
%	\label{fig:catastrophicReactionWheels}
%\end{figure}
%
%\begin{figure}[!htb]
%	\centering
%	
%	\import{Figures/TexFigures/Summary/SVM/}{Estimation MetricSVMRFDT.pgf}
%	
%	\caption{Estimation Metric with failure of Reaction Wheels}
%	\label{fig:catastrophicReactionWheels}
%\end{figure}
%
%\begin{figure}[!htb]
%	\centering
%	
%	\import{Figures/TexFigures/Summary/DecisionTrees100/}{Estimation MetricSVMRFDT.pgf}
%	
%	\caption{Estimation Metric with failure of Reaction Wheels}
%	\label{fig:catastrophicReactionWheels}
%\end{figure}
%
%\begin{figure}[!htb]
%	\centering
%	
%	\import{Figures/TexFigures/Summary/RandomForest100/}{Estimation MetricSVMRFDT.pgf}
%	
%	\caption{Estimation Metric with failure of Reaction Wheels}
%	\label{fig:catastrophicReactionWheels}
%\end{figure}
%
%\begin{figure}[!htb]
%	\centering
%	
%	\import{Figures/TexFigures/Summary/DecisionTrees100/}{Prediction AccuracySVMRFDT.pgf}
%	
%	\caption{Estimation Metric with failure of Reaction Wheels}
%	\label{fig:catastrophicReactionWheels}
%\end{figure}
%
%\begin{figure}[!htb]
%	\centering
%	
%	\import{Figures/TexFigures/Summary/RandomForest100/}{Prediction AccuracySVMRFDT.pgf}
%	
%	\caption{Estimation Metric with failure of Reaction Wheels}
%	\label{fig:catastrophicReactionWheels}
%\end{figure}

