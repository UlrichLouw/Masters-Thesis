\chapter{System Perturbation Matrix}
\makeatletter\@mkboth{}{Appendix}\makeatother
\label{appen:derivations_bigramseg}

This section will show the derivation of the Jacobian matrix $\mathbf{F}_{t}$ that must be constructed in the execution of the full state EKF, as described in Section 5.4.

The continuous system perturbation matrix $\mathbf{F}_{t}$ can be constructed by determining its individual components, thus
$$
\mathbf{F}_{t}=\left[\begin{array}{ll}
\frac{\partial \dot{\omega}_{B}^{I}}{\partial \omega_{B}^{I}} & \frac{\partial \dot{\omega}_{B}^{I}}{\partial \mathbf{q}} \\
\frac{\partial \dot{\mathbf{q}}}{\partial \omega_{B}^{I}} & \frac{\partial \dot{\mathbf{q}}}{\partial \mathbf{q}}
\end{array}\right]_{\omega_{B}^{I}=\hat{\omega}_{B}^{I}, \mathbf{q}=\hat{\mathbf{q}}}
$$
Note that the subscript ' $t$ ' indicating the time domain has been dropped from Equation $5.4 .5$ to simplify the derivation. The non-linear function $\boldsymbol{f}(\mathbf{x})$ can be separated into two parts: a non-linear function describing $\dot{\omega}_{B}^{I}$ and a non-linear function describing $\dot{\mathbf{q}}$. The continuous non-linear system equation with regards to $\dot{\omega}_{B}^{I}$ is the Euler dynamic equation, or
$$
\dot{\boldsymbol{\omega}}_{B}^{I}=\mathbf{J}^{-1}\left(\mathbf{N}_{c}+\mathbf{N}_{d}-\boldsymbol{\omega}_{B}^{I} \times\left(\mathbf{J} \boldsymbol{\omega}_{B}^{I}+\mathbf{h}_{w}\right)\right)
$$
The individual components of Equation B.2 can also be expressed as
$$
\begin{aligned}
\dot{\omega}_{x i} &=\frac{1}{I_{x x}}\left(N_{c x}+N_{d x}-\omega_{y i}\left(I_{z z} \omega_{z i}+h_{z}\right)+\omega_{z i}\left(I_{y y} \omega_{y i}+h_{y}\right)\right) \\
\dot{\omega}_{y i} &=\frac{1}{I_{y y}}\left(N_{c y}+N_{d y}-\omega_{z i}\left(I_{x x} \omega_{x i}+h_{x}\right)+\omega_{x i}\left(I_{z z} \omega_{z i}+h_{z}\right)\right) \\
\dot{\omega}_{z i} &=\frac{1}{I_{z z}}\left(N_{c z}+N_{d z}-\omega_{x i}\left(I_{y y} \omega_{y i}+h_{y}\right)+\omega_{y i}\left(I_{x x} \omega_{x i}+h_{x}\right)\right) .
\end{aligned}
$$
Using Equations B.3 to B.5, $\frac{\partial \dot{\omega}_{B}^{I}}{\partial \omega_{B}^{I}}$ can be determined by taking each individual partial derivative, which delivers
$$
\frac{\partial \dot{\boldsymbol{\omega}}_{B}^{I}}{\partial \boldsymbol{\omega}_{B}^{I}}=\left[\begin{array}{ccc}
0 & \frac{\omega_{z i}\left(I_{y y}-I_{z z}\right)-h_{z}}{I_{x x}} & \frac{\omega_{y i}\left(I_{y y}-I_{z z}\right)+h_{y}}{I_{x x}} \\
\frac{\omega_{z i}\left(I_{z z}-I_{x x}\right)+h_{z}}{I_{y y}} & 0 & \frac{\omega_{x i}\left(I_{z z}-I_{x x}\right)-h_{x}}{I_{y y}} \\
\frac{\omega_{y i}\left(I_{x x}-I_{y y}\right)-h_{y}}{I_{z z}} & \frac{\omega_{x i}\left(I_{x x}-I_{y y}\right)+h_{x}}{I_{z z}} & 0
\end{array}\right] .
$$
$\frac{\partial \dot{\boldsymbol{\omega}}_{B}^{I}}{\partial \mathbf{q}}$ is however much more difficult to determine. The first step is to determine which components of Equation B.2 are dependent on the attitude quaternion of the satellite. The control torque $\mathbf{N}_{c}$ is the sum of the torques generated by the ADCS actuators, which means that $\mathbf{N}_{c}$ is independent of $\mathbf{q}$. $\mathbf{N}_{\text {gyro }}$ is calculated using only the moment of inertia matrix, the angular rates and the stored angular momentum, which means that $\mathbf{N}_{\text {gyro }}$ is also independent of $\mathbf{q}$. Although there are many sources of disturbance torques, $\mathbf{N}_{d}$ at a LEO orbit is simplified to contain only two major components, namely gravity gradient torque $\left(\mathbf{N}_{g g}\right)$ and aerodynamic torque $\left(\mathbf{N}_{a e r o}\right)$. Even though both these components are dependent on the attitude of the satellite, only $\mathbf{N}_{g g}$ can be calculated accurately, thus
$$
\mathbf{N}_{d} \approx \mathbf{N}_{g g}
$$
$\mathbf{N}_{d}$ can thus easily be expressed in terms of quaternions using Equation $2.3 .3$ as
$$
\begin{aligned}
&\mathrm{N}_{d x} \approx k_{g x}\left(2\left[q_{2} q_{3}+q_{1} q_{4}\right]\right)\left(-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}+q_{4}^{2}\right) \\
&\mathrm{N}_{d y} \approx k_{g y}\left(2\left[q_{1} q_{3}-q_{2} q_{4}\right]\right)\left(-q_{1}^{2}-q_{2}^{2}+q_{3}^{2}+q_{4}^{2}\right) \\
&\mathrm{N}_{d z} \approx k_{g z}\left(2\left[q_{1} q_{3}-q_{2} q_{4}\right]\right)\left(2\left[q_{2} q_{3}+q_{1} q_{4}\right]\right)
\end{aligned}
$$
$\frac{\partial \dot{\omega}_{B}^{I}}{\partial \mathbf{q}}$ can now be calculated as
$$
\frac{\partial \dot{\boldsymbol{\omega}}_{B}^{I}}{\partial \mathbf{q}}=\mathbf{J}^{-1}\left[\frac{\partial \mathbf{N}_{d}}{\partial \mathbf{q}}\right]=\mathbf{K}\left[\begin{array}{llll}
\mathbf{d}_{1} & \mathbf{d}_{2} & \mathbf{d}_{3} & \mathbf{d}_{4}
\end{array}\right]
$$
where
$$
\mathbf{K}=\left[\begin{array}{ccc}
2 k_{g x} & 0 & 0 \\
0 & 2 k_{g y} & 0 \\
0 & 0 & 2 k_{g z}
\end{array}\right]
$$
and

$\frac{\partial \dot{\mathbf{q}}}{\partial \boldsymbol{\omega}_{B}^{I}}$ and $\frac{\partial \dot{\mathbf{q}}}{\partial \mathbf{q}}$ can be determined by partially deriving the time derivative of $\mathbf{q}$, which is

$$\dot{\mathbf{q}} = \frac{1}{2} \boldsymbol{\Omega}(\omega_{\mathcal{B}}^{\mathcal{O}}) \mathbf{q},$$

where $$\boldsymbol{\Omega}(\omega_{\mathcal{B}}^{\mathcal{O}}) = \begin{bmatrix}
	0 & \omega_{zo} & -\omega_{yo} & \omega_{xo} \\
	-\omega_{zo} & 0 & \omega_{xo} & \omega{yo} \\
	\omega_{yo} & -\omega{xo} & 0 & \omega_{zo} \\
	-\omega_{xo} & -\omega_{yo} & -\omega_{zo} & 0 \\
\end{bmatrix}$$

The relationship between $\omega_{B}^{I}$ and $\omega_{B}^{O}$ is given by
$$
\boldsymbol{\omega}_{B}^{O}=\boldsymbol{\omega}_{B}^{I}-\mathbf{A}\left[\begin{array}{c}
0 \\
-\omega_{o} \\
0
\end{array}\right]=\left[\begin{array}{c}
\omega_{x i}+\omega_{o} A_{12} \\
\omega_{y i}+\omega_{o} A_{22} \\
\omega_{z i}+\omega_{o} A_{32}
\end{array}\right]
$$
which means that $\frac{\partial \dot{q}}{\partial \omega_{B}^{I}}$ can be determined as
$$
\frac{\partial \dot{\mathbf{q}}}{\partial \omega_{B}^{I}}=\left[\begin{array}{ccc}
\frac{\partial \dot{q}_{1}}{\partial \omega_{x i}} & \frac{\partial \dot{q}_{1}}{\partial \omega_{y i}} & \frac{\partial \dot{q}_{1}}{\partial \omega_{z i}} \\
\frac{\partial \dot{q}_{2}}{\partial \omega_{x i}} & \frac{\partial \dot{q}_{2}}{\partial \omega_{y i}} & \frac{\partial \dot{q}_{2}}{\partial \omega_{z i}} \\
\frac{\partial \dot{q}_{3}}{\partial \omega_{x i}} & \frac{\partial \dot{q}_{3}}{\partial \omega_{y i}} & \frac{\partial \dot{q}_{3}}{\partial \omega_{z i}} \\
\frac{\partial \dot{q}_{4}}{\partial \omega_{x i}} & \frac{\partial \dot{q}_{4}}{\partial \omega_{y i}} & \frac{\partial \dot{q}_{4}}{\partial \omega_{z i}}
\end{array}\right]=\frac{1}{2}\left[\begin{array}{ccc}
\hat{q}_{4} & -\hat{q}_{3} & \hat{q}_{2} \\
\hat{q}_{3} & \hat{q}_{4} & -\hat{q}_{1} \\
-\hat{q}_{2} & \hat{q}_{1} & \hat{q}_{4} \\
-\hat{q}_{1} & -\hat{q}_{2} & -\hat{q}_{3}
\end{array}\right]
$$
$\frac{\partial \dot{\mathbf{q}}}{\partial \mathbf{q}}$ can be determined by substituting Equation B.13 into Equation B.12, which delivers
$$
\begin{aligned}
\dot{q}_{1} &=\frac{1}{2}\left(q_{2}\left(\omega_{z i}-\omega_{o} A_{32}\right)-q_{3}\left(\omega_{y i}-\omega_{o} A_{22}\right)+q_{4}\left(\omega_{x i}-\omega_{o} A_{12}\right)\right) \\
\dot{q}_{2} &=\frac{1}{2}\left(-q_{1}\left(\omega_{z i}-\omega_{o} A_{32}\right)+q_{3}\left(\omega_{x i}-\omega_{o} A_{12}\right)+q_{4}\left(\omega_{y i}-\omega_{o} A_{22}\right)\right) \\
\dot{q}_{3} &=\frac{1}{2}\left(q_{1}\left(\omega_{y i}-\omega_{o} A_{22}\right)-q_{2}\left(\omega_{x i}-\omega_{o} A_{12}\right)+q_{4}\left(\omega_{z i}-\omega_{o} A_{32}\right)\right) \\
\dot{q}_{4} &=\frac{1}{2}\left(-q_{1}\left(\omega_{x i}-\omega_{o} A_{12}\right)-q_{2}\left(\omega_{y i}-\omega_{o} A_{22}\right)-q_{3}\left(\omega_{z i}-\omega_{o} A_{32}\right)\right)
\end{aligned}
$$
$$
\begin{aligned}
& \mathbf{d}_{1}=\left[\begin{array}{c}\frac{-q_{1} A_{23}+q_{4} A_{33}}{I_{x x}} \\\frac{-q_{1} A_{13}+q_{3} A_{33}}{I_{y y}} \\\frac{q_{3} A_{23}+q_{4} A_{13}}{I_{z z}}\end{array}\right] \quad \mathbf{d}_{2}=\left[\begin{array}{l}\frac{-q_{2} A_{23}+q_{3} A_{33}}{I_{x x}} \\\frac{-q_{2} A_{13}-q_{4} A_{33}}{I_{y y}} \\\frac{-q_{4} A_{23}+q_{3} A_{13}}{I_{z z}}\end{array}\right] \\
& \mathbf{d}_{3}=\left[\begin{array}{c}\frac{q_{3} A_{23}+q_{2} A_{33}}{I_{x x}} \\\frac{q_{3} A_{13}+q_{1} A_{33}}{I_{y y}} \\\frac{q_{1} A_{23}+q_{2} A_{13}}{I_{z z}}\end{array}\right] \quad \mathbf{d}_{4}=\left[\begin{array}{c}\frac{q_{4} A_{23}+q_{1} A_{33}}{I_{x x}} \\\frac{q_{4} A_{13}-q_{2} A_{33}}{I_{y y}} \\\frac{-q_{2} A_{23}+q_{1} A_{13}}{I_{z z}}\end{array}\right] . 
\end{aligned}
$$
By partially deriving Equations B.15 to B.18 and performing some mathematical manipulation, $\frac{\partial \dot{\mathbf{q}}}{\partial \mathbf{q}}$ can be calculated as
$$
\frac{\partial \dot{\mathbf{q}}}{\partial \mathbf{q}}=\frac{1}{2}\left[\Omega\left(\boldsymbol{\omega}_{B}^{O}\right)\right]+\omega_{o}\left[\begin{array}{cccc}
\hat{q}_{1} \hat{q}_{3} & \hat{q}_{1} \hat{q}_{4} & 1-\hat{q}_{1}^{2} & -\hat{q}_{1} \hat{q}_{2} \\
\hat{q}_{2} \hat{q}_{3} & \hat{q}_{2} \hat{q}_{4} & -\hat{q}_{1} \hat{q}_{2} & 1-\hat{q}_{2}^{2} \\
-\left(1-\hat{q}_{3}^{2}\right) & \hat{q}_{3} \hat{q}_{4} & -\hat{q}_{1} \hat{q}_{3} & -\hat{q}_{2} \hat{q}_{3} \\
\hat{q}_{3} \hat{q}_{4} & -\left(1-\hat{q}_{4}^{2}\right) & -\hat{q}_{1} \hat{q}_{4} & -\hat{q}_{2} \hat{q}_{4}
\end{array}\right]
$$

\chapter{Measurement Perturbation Jacobian Matrix}
\makeatletter\@mkboth{}{Appendix}\makeatother
\label{chap:Measurement Perturbation Jacobian Matrix}
This section will show the derivation of the Jacobian matrix $\mathbf{H}_{k}$ that must be constructed in the execution of the full state $\mathrm{EKF}$, as described in Section $5.4 .$

The discrete measurement perturbation matrix $\mathbf{H}_{k}$ from Equation $5.4 .12$ can be determined by partially deriving the non-linear function $\boldsymbol{h}\left(\mathbf{x}_{k}\right)$, which is given by Equation $5.4 .15$ as
$$
\boldsymbol{h}\left(\mathbf{x}_{k}\right)=\mathbf{A} \mathbf{v}_{\text {model }, k} .
$$
Since $\mathbf{A}$ is constructed from $\mathbf{q}$ only, Equation B.20 suggests that $\boldsymbol{h}\left(\mathbf{x}_{k}\right)$ is independent of $\boldsymbol{\omega}_{B}^{I}$, thus
$$
\mathbf{H}_{k}=\left[\begin{array}{lllllll}
0 & 0 & 0 & \frac{\partial h_{1}}{\partial q_{1}} & \frac{\partial h_{1}}{\partial q_{2}} & \frac{\partial h_{1}}{\partial q_{3}} & \frac{\partial h_{1}}{\partial q_{4}} \\
0 & 0 & 0 & \frac{\partial h_{2}}{\partial q_{1}} & \frac{\partial h_{2}}{\partial q_{2}} & \frac{\partial h_{2}}{\partial q_{3}} & \frac{\partial h_{2}}{\partial q_{4}} \\
0 & 0 & 0 & \frac{\partial h_{3}}{\partial q_{1}} & \frac{\partial h_{3}}{\partial q_{2}} & \frac{\partial h_{3}}{\partial q_{3}} & \frac{\partial h_{3}}{\partial q_{4}}
\end{array}\right]_{\mathbf{q}=\hat{\mathbf{q}}}
$$
$\mathbf{H}_{k}$ can thus be calculated as
$$
\mathbf{H}_{k}=\left[\begin{array}{lllll}
\mathbf{0}_{[3 \times 3]} & \mathbf{h}_{1} & \mathbf{h}_{2} & \mathbf{h}_{3} & \mathbf{h}_{4}
\end{array}\right] \text {, }
$$
where $\quad \mathbf{h}_{1}=2\left[\begin{array}{ccc}q_{1} & q_{2} & q_{3} \\ q_{2} & -q_{1} & q_{4} \\ q_{3} & -q_{4} & -q_{1}\end{array}\right] \mathbf{v}_{\text {model }, k}$,
$$
\mathbf{h}_{2}=2\left[\begin{array}{ccc}
-q_{2} & q_{1} & -q_{4} \\
q_{1} & q_{2} & q_{3} \\
q_{4} & q_{3} & -q_{2}
\end{array}\right] \mathbf{v}_{\text {model }, k}
$$
$\mathbf{h}_{3}=2\left[\begin{array}{ccc}-q_{3} & q_{4} & q_{1} \\ -q_{4} & -q_{3} & q_{2} \\ q_{1} & q_{2} & q_{3}\end{array}\right] \mathbf{v}_{\text {model }, k}$

and $\quad \mathbf{h}_{4}=2\left[\begin{array}{ccc}q_{4} & q_{3} & -q_{2} \\ -q_{3} & q_{4} & q_{1} \\ q_{2} & -q_{1} & q_{4}\end{array}\right] \mathbf{v}_{\text {model }, k}$

\chapter{System Noise Covariance Matrix}
\makeatletter\@mkboth{}{Appendix}\makeatother
\label{chap:System Noise Covariance Matrix}
This section will show the derivation of the covariance matrix $\mathbf{Q}_{k}$ that must be constructed in the execution of the full state EKF, as described in Section $5.4 .$

The system noise covariance matrix $\mathbf{Q}_{k}$ can easily be determined from the continuous domain system noise covariance matrix $\mathbf{Q}_{t}$ if the following assumptions are made:

\begin{itemize}
	\item The angular rate noise (due to unmodelled disturbance torques and modelling errors) is uncorrelated.
	
	\item The system noise is small enough to allow the state matrix $\boldsymbol{\Phi}_{k}$ to be approximated using only two terms without significant inaccuracies, thus $\mathbf{\Phi}_{k} \approx \mathbf{I}+\left[T_{s} \mathbf{F}_{t}\right]_{t=k T_{s}}$.
	
	\item The angular rate noise for each axis is equal, thus $\sigma_{\omega x}=\sigma_{\omega y}=\sigma_{\omega z}=\sigma_{\omega}$.
	
\end{itemize}
Given the above-mentioned assumptions, the angular rate noise covariance matrix $\mathbf{Q}_{\omega, t}$ is given as
$$
\mathbf{Q}_{\omega, t}=\left[\begin{array}{ccc}
\sigma_{\omega}^{2} & 0 & 0 \\
0 & \sigma_{\omega}^{2} & 0 \\
0 & 0 & \sigma_{\omega}^{2}
\end{array}\right]
$$
$\mathbf{q}$ is completely described by the equations in Section 5.4, which means that the noise covariance of the last four states of the system $\left(\mathbf{Q}_{q, t}\right)$ is simply a zero matrix, or
$$
\mathbf{Q}_{q, t}=\mathbf{0}_{[4 \times 4]}
$$
$\mathbf{Q}_{t}$ can be formed from Equations B.23 and B.24 as
$$
\begin{aligned}
\mathbf{Q}_{t} &=\left[\begin{array}{ll}
\mathbf{Q}_{\omega, t} & \mathbf{0}_{[3 \times 4]} \\
\mathbf{0}_{[4 \times 3]} & \mathbf{Q}_{q, t}
\end{array}\right] \\
&=\left[\begin{array}{ll}
\mathbf{Q}_{\omega, t} & \mathbf{0}_{[3 \times 4]} \\
\mathbf{0}_{[4 \times 3]} & \mathbf{0}_{[4 \times 4]}
\end{array}\right]
\end{aligned}
$$
$\mathbf{F}_{t}$ can also be express in the form of Equation B.26 as
$$
\mathbf{F}_{t}=\left[\begin{array}{ll}
\mathbf{F}_{11[3 \times 3]} & \mathbf{F}_{12[3 \times 4]} \\
\mathbf{F}_{21[4 \times 3]} & \mathbf{F}_{22[4 \times 4]}
\end{array}\right]
$$
$\mathbf{Q}_{k}$ can now be determined by converting $\mathbf{Q}_{t}$ to the discrete domain. Through a process of integration $[21], \mathbf{Q}_{k}$ is determined to be
$$
\mathbf{Q}_{k}=T_{s} \mathbf{S}_{1}+\frac{1}{2} T_{s}^{2} \mathbf{S}_{2}+\frac{1}{3} T_{s}^{3} \mathbf{S}_{3}
$$
where $\mathbf{S}_{1}=\mathbf{Q}_{t}$
$$
\begin{aligned}
&\mathbf{S}_{2}=\left[\begin{array}{cc}
\mathbf{Q}_{\omega, t} \mathbf{F}_{11}^{T}+\mathbf{F}_{11} \mathbf{Q}_{\omega, t} & \mathbf{Q}_{\omega, t} \mathbf{F}_{21}^{T} \\
\mathbf{F}_{21} \mathbf{Q}_{\omega, t} & \mathbf{0}_{[4 \times 4]}
\end{array}\right]_{t=k T_{s}} \\
&\mathbf{S}_{3}=\left[\begin{array}{ll}
\mathbf{F}_{11} \mathbf{Q}_{\omega, t} \mathbf{F}_{11}^{T} & \mathbf{F}_{11} \mathbf{Q}_{\omega, t} \mathbf{F}_{21}^{T} \\
\mathbf{F}_{21} \mathbf{Q}_{\omega, t} \mathbf{F}_{11}^{T} & \mathbf{F}_{21} \mathbf{Q}_{\omega, t} \mathbf{F}_{21}^{T}
\end{array}\right]_{t=k T_{s}}
\end{aligned}
$$
The computational load of calculating $\mathbf{Q}_{k}$ can be reduced if the assumption is made that $\mathbf{F}_{11}<<\mathbf{F}_{21}$ [21]. $\mathbf{Q}_{k}$ can then be simplified to
$$
\mathbf{Q}_{k}=\left[\begin{array}{cc}
T_{s} \mathbf{Q}_{\omega, t} & \frac{1}{2} T_{s}{ }^{2} \mathbf{Q}_{\omega, t} \mathbf{F}_{21}^{T} \\
\frac{1}{2} T_{s}{ }^{2} \mathbf{F}_{21} \mathbf{Q}_{\omega, t} & \frac{1}{3} T_{s}{ }^{3} \mathbf{F}_{21} \mathbf{Q}_{\omega, t} \mathbf{F}_{21}^{T}
\end{array}\right]_{t=k T_{s}}
$$

\chapter{Measurement Noise Covariance Matrix}
\makeatletter\@mkboth{}{Appendix}\makeatother
\label{chap:Measurement Noise Covariance Matrix}
This section will show the derivation of the covariance matrix $\mathbf{R}_{k}$ that must be constructed in the execution of the full state EKF, as described in Section 5.4.

The relationship between the true measured vector $\overline{\mathbf{v}}_{\text {meas, } k}$ and the true modelled vector $\overline{\mathbf{v}}_{\text {model }, k}$ is given by Equation $5.4 .13$ as
$$
\overline{\mathbf{v}}_{\text {meas }, k}=\mathbf{A}\left(\mathbf{q}_{k}\right) \overline{\mathbf{v}}_{\text {model }, k} .
$$
It should be noted that $\mathbf{A}_{k}=\mathbf{A}\left(\mathbf{q}_{k}\right)$. The added notation, which merely implies that $\mathbf{A}$ is a function of $\mathbf{q}_{k}$, will prove to be useful in the remainder of this section.

The measured and modelled vectors are furthermore related to their respective true vectors through
$$
\begin{aligned}
\mathbf{v}_{\text {meas }, k} &=\overline{\mathbf{v}}_{\text {meas }, k}+\mathbf{m}_{\text {meas }, k} \\
\text { and } \quad \mathbf{v}_{\text {model }, k} &=\overline{\mathbf{v}}_{\text {model }, k}+\mathbf{m}_{\text {model }, k}
\end{aligned}
$$
If $\Delta \mathbf{q}_{k}$ is defined as the difference between the true quaternion $\mathbf{q}_{k}$ and the estimated quaternion $\hat{\mathbf{q}}_{k}$,
$$
\Delta \mathbf{q}_{k}=\mathbf{q}_{k}-\hat{\mathbf{q}}_{k}
$$
then Equation $5.4 .13$ can also be expressed as
$$
\mathbf{v}_{\text {meas }, k}-\mathbf{m}_{\text {meas }, k}=\mathbf{A}\left(\hat{\mathbf{q}}_{k}+\Delta \mathbf{q}_{k}\right)\left(\mathbf{v}_{\text {model }, k}-\mathbf{m}_{\text {model }, k}\right)
$$
The Taylor series expansion from Equations $5.4 .4$ and $5.4 .11$ can also be used to approximate $\mathbf{A}\left(\hat{\mathbf{q}}_{k}+\right.$ $\left.\Delta \mathbf{q}_{k}\right)$ as
$$
\begin{aligned}
&\mathbf{A}\left(\hat{\mathbf{q}}_{k}+\Delta \mathbf{q}_{k}\right) \approx \mathbf{A}\left(\hat{\mathbf{q}}_{k}\right)+\mathbf{C}_{k} \Delta \mathbf{q}_{k} \\
&\text { where } \quad \mathbf{C}_{k}=\left[\frac{\partial \mathbf{A}\left(\hat{\mathbf{q}}_{k}\right)}{\partial \hat{\mathbf{q}}_{k}}\right]
\end{aligned}
$$
Substituting Equation B.37 into Equation B.36 delivers
$$
\mathbf{v}_{m e a s, k}-\mathbf{m}_{m e a s, k}=\left(\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right)+\mathbf{C}_{k} \Delta \mathbf{q}_{k}\right)\left(\mathbf{v}_{\text {model }, k}-\mathbf{m}_{\text {model }, k}\right)
$$
Given that the innovation $\mathbf{e}_{k}$ is defined by Equation $5.4 .17$ as
$$
\mathbf{e}_{k}=\mathbf{v}_{m e a s, k}-\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{v}_{m o d e l, k},
$$
substitution can be used to manipulate Equation B.39 into
$$
\mathbf{e}_{k}=\left(\mathbf{C}_{k} \mathbf{v}_{\text {model }, k}-\mathbf{C}_{k} \mathbf{m}_{\text {model }, k}\right) \Delta \mathbf{q}_{k}+\mathbf{m}_{\text {meas }, k}-\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{m}_{\text {model }, k}
$$
If it is assumed that $\mathbf{m}_{\text {model }, k}$ and $\Delta \mathbf{q}_{k}$ are extremely small compared respectively to $\mathbf{v}_{m o d e l}, k$ and $\mathbf{q}_{k}$, then
$$
\mathbf{m}_{\text {model }, k} \Delta \mathbf{q}_{k} \approx 0
$$
Equation B. 40 can thus be simplified to
$$
\begin{aligned}
\mathbf{e}_{k} &=\left[\mathbf{0}_{[3 \times 3]} \mathbf{C}_{k} \mathbf{v}_{\text {model }, k}\right] \Delta \mathbf{x}_{k}+\mathbf{m}_{k}, \\
\text { where } \quad \mathbf{m}_{k} &=\mathbf{m}_{\text {meas }, k}-\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{m}_{\text {model }, k}
\end{aligned}
$$
The covariance matrix $\mathbf{R}_{k}$ of $\mathbf{m}_{k}$ is defined as
$$
\begin{aligned}
\mathbf{R}_{k}=& \mathbb{E}\left\{\left(\mathbf{m}_{k}\right)\left(\mathbf{m}_{k}\right)^{T}\right\} \\
=& \mathbb{E}\left\{\left(\mathbf{m}_{\text {meas }, k}-\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{m}_{\text {model }, k}\right)\left(\mathbf{m}_{\text {meas }, k}-\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{m}_{\text {model }, k}\right)^{T}\right\} \\
=& \mathbb{E}\left\{\mathbf{m}_{\text {meas }, k} \mathbf{m}_{\text {meas }, k}^{T}-\right.\\
& \quad \mathbf{m}_{\text {meas }, k} \mathbf{m}_{\text {model }, k}^{T} \mathbf{A}\left(\hat{\mathbf{q}}_{k}\right)^{T}-\\
& \mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{m}_{\text {model }, k} \mathbf{m}_{\text {meas }, k}^{T}+\\
&\left.\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{m}_{\text {model }, k} \mathbf{m}_{\text {model }, k}^{T} \mathbf{A}\left(\hat{\mathbf{q}}_{k}\right)^{T}\right\} \\
=& \mathbb{E}\left\{\mathbf{m}_{\text {meas, } k} \mathbf{m}_{\text {meas }, k}^{T}\right\}-\\
& \mathbb{E}\left\{\mathbf{m}_{\text {meas }, k} \mathbf{m}_{\text {model }, k}^{T} \mathbf{A}\left(\hat{\mathbf{q}}_{k}\right)^{T}\right\}-\\
& \mathbb{E}\left\{\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{m}_{\text {model }, k} \mathbf{m}_{\text {meas }, k}^{T}\right\}+\\
& \mathbb{E}\left\{\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{m}_{\text {model }, k} \mathbf{m}_{\text {model }, k}^{T} \mathbf{A}\left(\hat{\mathbf{q}}_{k}\right)^{T}\right\}
\end{aligned}
$$
where $\mathbb{E}$ indicates the expected value operator. The last term of Equation B.44 can be simplified to
$$
\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{m}_{\text {model }, k} \mathbf{m}_{\text {model }, k} T \mathbf{A}\left(\hat{\mathbf{q}}_{k}\right)^{T}=\mathbf{m}_{\text {model }, k} \mathbf{m}_{\text {model }, k}^{T}
$$
since $\mathbf{m}_{\text {model }, k} \mathbf{m}_{\text {model, } k}^{T}$ is a scalar value and $\mathbf{A}\left(\hat{\mathbf{q}}_{k}\right) \mathbf{A}\left(\hat{\mathbf{q}}_{k}\right)^{T}=1$. If it is furthermore assumed that the measurement noise and the model noise are uncorrelated and that each noise vector has equal variance in its 3 axes, then Equation B. 44 becomes
$$
\begin{aligned}
\mathbf{R}_{k}=& \mathbb{E}\left\{\mathbf{m}_{\text {meas }, k} \mathbf{m}_{\text {meas }, k}^{T}\right\}+\\
& \mathbb{E}\left\{\mathbf{m}_{\text {model }, k} \mathbf{m}_{\text {model }, k}^{T}\right\} \\
=&\left(\sigma_{\text {meas }}^{2}+\sigma_{\text {model }}^{2}\right) \mathbf{I}_{3 \times 3}
\end{aligned}
$$
where $\sigma_{\text {meas }}$ and $\sigma_{\text {model }}$ are the respective standard deviations of $\mathbf{m}_{\text {meas, } k}$ and $\mathbf{m}_{\text {model, }, k}$. It is also assumed that $\sigma_{\text {meas }}$ and $\sigma_{\text {model }}$ are constant.